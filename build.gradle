/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn more about Gradle by exploring our samples at https://docs.gradle.org/7.2/samples
 */

plugins {
    id 'java'
    id 'org.springframework.boot' version "${springBootVersion}"
    id 'io.spring.dependency-management' version '1.1.7'
    id 'com.google.protobuf' version '0.9.5'
    id 'application'
}

bootJar {
    enabled = false
}

gradle.buildFinished {
    project.buildDir.deleteDir()
}

allprojects {

    repositories {
        mavenCentral()
    }

    java {
        toolchain {
            languageVersion = JavaLanguageVersion.of(21)
        }
    }
    
}

configure(subprojects.findAll { it.name == "messaging@grpc@server" }) {

    apply plugin: 'com.google.protobuf'
    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'

    dependencies {
        implementation 'org.springframework.boot:spring-boot-starter'
        implementation 'org.springframework.grpc:spring-grpc-spring-boot-starter'
        implementation 'org.springframework.boot:spring-boot-starter-webmvc'

        testImplementation 'org.springframework.boot:spring-boot-starter-test'
        testImplementation 'org.springframework.grpc:spring-grpc-test'
        testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
        testImplementation 'org.springframework.boot:spring-boot-starter-webmvc-test'
    }

    dependencyManagement {
        imports {
            mavenBom "org.springframework.grpc:spring-grpc-dependencies:" + springGrpcVersion
        }
    }

    protobuf {
        protoc {
            artifact = 'com.google.protobuf:protoc'
        }
        plugins {
            grpc {
                artifact = 'io.grpc:protoc-gen-grpc-java'
            }
        }
        generateProtoTasks {
            all()*.plugins {
                grpc {
                    option '@generated=omit'
                }
            }
        }
    }

}

configure(subprojects.findAll { it.name == "messaging@grpc@client" }) {

    apply plugin: 'com.google.protobuf'
    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'

    dependencies {
        implementation 'org.springframework.boot:spring-boot-starter'
        implementation 'org.springframework.grpc:spring-grpc-spring-boot-starter'
        implementation 'org.springframework.boot:spring-boot-starter-webmvc'

        testImplementation 'org.springframework.boot:spring-boot-starter-test'
        testImplementation 'org.springframework.grpc:spring-grpc-test'
        testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
        testImplementation 'org.springframework.boot:spring-boot-starter-webmvc-test'
    }

    dependencyManagement {
        imports {
            mavenBom "org.springframework.grpc:spring-grpc-dependencies:" + springGrpcVersion
        }
    }

    protobuf {
        protoc {
            artifact = 'com.google.protobuf:protoc'
        }
        plugins {
            grpc {
                artifact = 'io.grpc:protoc-gen-grpc-java'
            }
        }
        generateProtoTasks {
            all()*.plugins {
                grpc {
                    option '@generated=omit'
                }
            }
        }
    }

}

configure(subprojects.findAll { it.name == "messaging@rest@sender" }) {

    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'
    

    dependencies {
        implementation 'org.springframework.boot:spring-boot-starter-web'
        implementation 'org.springframework.boot:spring-boot-starter-aop:' + springBootStarterAop

        implementation 'org.springframework.boot:spring-boot-restclient'
    }
}

configure(subprojects.findAll { it.name == "messaging@rest@receiver" }) {

    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'
    

    dependencies {
        implementation 'org.springframework.boot:spring-boot-starter-web'
    }

    
}

configure(subprojects.findAll { it.name == "messaging@consumer" }) {

    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'
    

    

    dependencies {
        implementation 'org.springframework.boot:spring-boot-starter-web'
        implementation 'org.springframework.kafka:spring-kafka'
    }

    
}

configure(subprojects.findAll { it.name == "messaging@event_sourcing@consumer" }) {

    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'
    

    

    dependencies {
        implementation 'org.springframework.boot:spring-boot-starter-web'
        implementation 'org.springframework.kafka:spring-kafka'
    }

    
}

configure(subprojects.findAll { it.name == "messaging@event_sourcing@producer" }) {

    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'
    

    

    dependencies {
        implementation 'org.springframework.boot:spring-boot-starter-web'
        implementation 'org.springframework.boot:spring-boot-starter-kafka'
        testImplementation 'org.springframework.boot:spring-boot-starter-kafka-test'
    }

    
}

configure(subprojects.findAll { it.name == "shared_database@order_service"}) {

    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'
    

    

    

    dependencies {
        implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
        implementation 'org.springframework.boot:spring-boot-starter-web'
        implementation 'org.springdoc:springdoc-openapi-ui:1.7.0'


        runtimeOnly 'org.postgresql:postgresql'


        testImplementation 'org.springframework.boot:spring-boot-starter-test'
        testImplementation 'com.h2database:h2'

        testImplementation 'org.springframework.boot:spring-boot-data-jpa-test'

        testImplementation 'org.springframework.boot:spring-boot-starter-webmvc-test'

    }

    tasks.named('test') {
        useJUnitPlatform()
    }
}

configure(subprojects.findAll { it.name == "shared_database@customer_service"}) {

    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'
    

    

    

    dependencies {
        implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
        implementation 'org.springframework.boot:spring-boot-starter-web'
        implementation 'org.springdoc:springdoc-openapi-ui:1.7.0'


        runtimeOnly 'org.postgresql:postgresql'


        testImplementation 'org.springframework.boot:spring-boot-starter-test'
        testImplementation 'com.h2database:h2'

        testImplementation 'org.springframework.boot:spring-boot-data-jpa-test'

        testImplementation 'org.springframework.boot:spring-boot-starter-webmvc-test'
    }

    tasks.named('test') {
        useJUnitPlatform()
    }
}

configure(subprojects.findAll { it.name == "private_table_per_service@order_service"}) {

    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'
    

    

    

    dependencies {
        implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
        implementation 'org.springframework.boot:spring-boot-starter-web'
        implementation 'org.springdoc:springdoc-openapi-ui:1.7.0'


        runtimeOnly 'org.postgresql:postgresql'


        testImplementation 'org.springframework.boot:spring-boot-starter-test'
        testImplementation 'com.h2database:h2'

        testImplementation 'org.springframework.boot:spring-boot-data-jpa-test'

        testImplementation 'org.springframework.boot:spring-boot-starter-webmvc-test'

    }

    tasks.named('test') {
        useJUnitPlatform()
    }
}


configure(subprojects.findAll { it.name == "private_table_per_service@customer_service"}) {

    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'
    

    

    

    dependencies {
        implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
        implementation 'org.springframework.boot:spring-boot-starter-web'
        implementation 'org.springdoc:springdoc-openapi-ui:1.7.0'


        runtimeOnly 'org.postgresql:postgresql'


        testImplementation 'org.springframework.boot:spring-boot-starter-test'
        testImplementation 'com.h2database:h2'

        testImplementation 'org.springframework.boot:spring-boot-data-jpa-test:4.0.0'

        testImplementation 'org.springframework.boot:spring-boot-starter-webmvc-test:4.0.0'

    }

    tasks.named('test') {
        useJUnitPlatform()
    }
}

configure(subprojects.findAll { it.name == "messaging@graphql"}) {

    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'
    

    

    

    dependencies {
        implementation 'org.springframework.boot:spring-boot-starter-web'
        implementation 'org.springframework.boot:spring-boot-starter-graphql'

    }
}

configure(subprojects.findAll { it.name == "circuit_breaker@proxy"}) {

    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'

    dependencies {
        implementation 'org.springframework.boot:spring-boot-starter-web'
        implementation 'io.vavr:vavr:0.10.4'
        implementation 'org.springframework.cloud:spring-cloud-starter-circuitbreaker-resilience4j'
        implementation 'org.springframework.boot:spring-boot-starter-actuator'
        implementation 'org.springframework.boot:spring-boot-starter-aop:3.5.8'

        implementation 'org.springframework.boot:spring-boot-restclient:4.0.0'

        compileOnly 'org.jetbrains:annotations:26.0.2-1'

        dependencyManagement {
            imports {
                mavenBom("org.springframework.cloud:spring-cloud-dependencies:" + springCloudVersion)
            }
        }


    }
}

configure(subprojects.findAll { it.name == "circuit_breaker@real_service"}) {

    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'

    dependencies {
        implementation 'org.springframework.boot:spring-boot-starter-web'
    }
}

configure(subprojects.findAll { it.name == "self_registration@services_registry"}) {

    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'

    dependencies {
        implementation 'org.springframework.cloud:spring-cloud-starter-netflix-eureka-server'
    }

    dependencyManagement {
        imports {
            mavenBom("org.springframework.cloud:spring-cloud-dependencies:" + springCloudVersion)
        }
    }

}

configure(subprojects.findAll { it.name == "self_registration@services_A"}) {

    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'

    dependencies {
        implementation 'org.springframework.cloud:spring-cloud-starter-netflix-eureka-client'
        implementation 'org.springframework.boot:spring-boot-starter-web'
    }

    dependencyManagement {
        imports {
            mavenBom("org.springframework.cloud:spring-cloud-dependencies:" + springCloudVersion)
        }
    }

}

configure(subprojects.findAll { it.name == "client_side_discovery@services_A"}) {

    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'

    dependencies {
        implementation 'org.springframework.cloud:spring-cloud-starter-netflix-eureka-client'
        implementation 'org.springframework.boot:spring-boot-starter-web'
    }

    dependencyManagement {
        imports {
            mavenBom("org.springframework.cloud:spring-cloud-dependencies:" + springCloudVersion)
        }
    }

}

configure(subprojects.findAll { it.name == "client_side_discovery@services_registry"}) {

    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'

    dependencies {
        implementation 'org.springframework.cloud:spring-cloud-starter-netflix-eureka-server'
    }

    dependencyManagement {
        imports {
            mavenBom("org.springframework.cloud:spring-cloud-dependencies:" + springCloudVersion)
        }
    }

}

configure(subprojects.findAll { it.name == "client_side_discovery@client"}) {

    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'

    dependencies {
        implementation 'org.springframework.cloud:spring-cloud-starter-netflix-eureka-client'
        implementation 'org.springframework.boot:spring-boot-starter-web'
        implementation 'org.springframework.cloud:spring-cloud-starter-loadbalancer'
    }

    dependencyManagement {
        imports {
            mavenBom("org.springframework.cloud:spring-cloud-dependencies:" + springCloudVersion)
        }
    }

}

configure(subprojects.findAll { it.name == "server_side_discovery@services_A"}) {

    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'

    dependencies {
        implementation 'org.springframework.boot:spring-boot-starter-web'
    }

    dependencyManagement {
        imports {
            mavenBom("org.springframework.cloud:spring-cloud-dependencies:" + springCloudVersion)
        }
    }

}

configure(subprojects.findAll { it.name == "transactional_outbox_pattern@transaction_log_tailling@order_service"}) {

    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'

    dependencies {
        implementation 'org.springframework.boot:spring-boot-starter-web'
        implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
        implementation("jakarta.validation:jakarta.validation-api:3.1.1")
        implementation("org.springframework.boot:spring-boot-starter-actuator")

        runtimeOnly 'org.postgresql:postgresql'


        testImplementation 'org.springframework.boot:spring-boot-starter-test'

        testImplementation 'org.springframework.boot:spring-boot-starter-webmvc-test:4.0.0'
    }

    tasks.named('test') {
        useJUnitPlatform()
    }
}

configure(subprojects.findAll{ it.name == 'transactional_outbox_pattern@transaction_log_tailling@order_service_heart_beat'}) {
    apply plugin: 'java'
    apply plugin: 'application'

    application {
        mainClass = 'nawaphon.microservices.transactional_outbox_pattern.order_service_heart_beat.Heartbeat'
    }

    jar {
        manifest {
            attributes 'Main-Class': 'nawaphon.microservices.transactional_outbox_pattern.order_service_heart_beat.Heartbeat'
        }
    }

    tasks.named('build').configure {
        it.dependsOn(':transactional_outbox_pattern@transaction_log_tailling@order_service:build')
        it.finalizedBy('copyJarFile')
    }

    tasks.register('copyJarFile', Copy) {
        it.from(layout.buildDirectory.dir('libs'))
        it.into(project(':transactional_outbox_pattern@transaction_log_tailling@order_service').layout.buildDirectory.dir('libs'))
        it.include("*.jar")

        it.dependsOn(':transactional_outbox_pattern@transaction_log_tailling@order_service_heart_beat:build')
    }

}
